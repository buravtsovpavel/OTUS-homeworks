# Цель домашнего задания
написать скрипт на языке Bash



---


## Описание домашнего задания
Написать скрипт для CRON, который раз в час будет формировать письмо и отправлять на заданную почту.
Необходимая информация в письме:
* Список IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
* Список запрашиваемых URL (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
* Ошибки веб-сервера/приложения c момента последнего запуска;
* Список всех кодов HTTP ответа с указанием их кол-ва с момента последнего запуска скрипта.

Скрипт должен предотвращать одновременный запуск нескольких копий, до его завершения.
В письме должен быть прописан обрабатываемый временной диапазон.

---
[Скрипт](https://github.com/buravtsovpavel/OTUS-homeworks/blob/master/09-BASH/access-log-ver1.sh) использует файл [variables.txt](https://github.com/buravtsovpavel/OTUS-homeworks/blob/master/09-BASH/variables.txt) для хранения значений времени последнего запуска и числа строк в логе при последнем запуске. В случае увеличения чила строк производит анализ лога начиная со строки на которой остановились в прошлый запуск, в случае уменьшения - анализирует с начала.

Гарантия предотвращения одновременного запуска нескольких копий реализована по примеру из вебинара с помощью создания lockfile и установки опции среды noclobber. Эта опция запрещает перезаписывать содержимое файла при перенаправлении. Если этот файл уже существует, то if завершится с ошибкой и мы попадаем в ветку else, где пишется, что не смогли захватить файл, что он захвачен другим процессом и PID этого процесса. ($$ - PID текущего процесса).

Отправка почты из командной строки c помощью команды mail. 

Для её использования нужно  установить дополнительные пакеты, такие как mailutils. В письме прописан обрабатываемый временной диапазон. Письмо посылаем на root@localhost

(при стандартных настройках при отправке на внешний почтовый сервер письмо либо попадет в спам, либо вообще не будет принято сервером получателя, потому что на сервере нет корректных настроек для отправки почты (dns записи, spf, dkim и т.д.). Чтобы почта нормально отправлялась, надо воспользоваться каким-то внешним почтовым сервером. Например настроить postfix на отправку локальных писем через внешний сервер с авторизацией по smtp.)



**Для добавления задания в CRON нужно прописать абсолютные пути до заданных в скрипте переменных иначе задание не выполняется.** 

Скрипт [provision.sh](https://github.com/buravtsovpavel/OTUS-homeworks/blob/master/09-BASH/provision.sh) служит для преднастройки при развёртывания через [vagrant](https://github.com/buravtsovpavel/OTUS-homeworks/blob/master/09-BASH/Vagrantfile). Так же при в этом случае необходимо указать абсолюные пути в [соответствующем скрипте](https://github.com/buravtsovpavel/OTUS-homeworks/blob/master/09-BASH/access-log-parse.sh) до объявленных переменных.

Для выполнения раз в минуту

sudo echo "* * * * * root /vagrant/access-log-parse.sh" > /etc/crontab

Для выполнения раз в час 

sudo echo "0 * * * * root /vagrant/access-log-parse.sh" > /etc/crontab
